#!/usr/bin/env bash
set -o errexit

main() {
  cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")"

  mkdir -p tmp/

  if [[ -n "${GCE_SERVICE_ACCOUNT_FILE_BZ2_B64}" ]]; then
    export GCE_ACCOUNT_FILE="$(pwd)/tmp/gce.json"
    echo "${GCE_SERVICE_ACCOUNT_FILE_BZ2_B64}" |
      base64 -d |
      bunzip2 >"${GCE_ACCOUNT_FILE}"
  fi

  gcloud auth activate-service-account "${GCE_SERVICE_ACCOUNT_ID}" \
    --key-file="${GCE_ACCOUNT_FILE}" --project="${GCE_PROJECT_ID}"

  if [[ ! "$(packer version 2>/dev/null)" =~ Packer\ v1.2.4 ]]; then
    make install-packer
  fi

  if ! bats --version &>/dev/null; then
    make install-bats
  fi
}

main "${@}"
